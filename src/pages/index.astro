---
import BaseHead from "@components/Head/BaseHead.astro";
import Nav from "@components/Nav.astro";
import Logo from "@components/Logo.astro";
import Card from "@components/Card.astro";
import ItchCard from "@components/ItchCard.astro";
import Footer from "@components/Footer/Footer.astro";

import { MarkdownFrontmatter, ItchGame } from "@scripts/types";
import { log } from "astro/dist/core/logger/core";

const title = "Mirth Peddlers";
const description = "A Theme for Astro";
const seoDescription = "Creek is a theme for Astro static site generator";

const allPosts = await Astro.glob<MarkdownFrontmatter>("./posts/*.md");
const sortedPosts = allPosts.sort((a, b) => new Date(b.frontmatter.pubDate).valueOf() - new Date(a.frontmatter.pubDate).valueOf());

let itchGames: ItchGame[];
try {
	const response = await fetch(`https://itch.io/api/1/${import.meta.env.ITCH_API_KEY}/my-games`);

	const data = await response.json();

	itchGames = data.games.sort((a, b) => new Date(b.published_at).getTime() - new Date(a.published_at).getTime());
} catch (error) {
	console.log(error);
}
---

<html lang="en">
	<head>
		<BaseHead title={title} description={seoDescription} />
	</head>

	<body class="leading-normal text-black bg-white font-body personality-casual">
		<header class="grid items-center grid-cols-2 px-lg pt-lg gap-lg">
			<div>
				<h1 data-test="header-title">
					<span class="sr-only">Mirth Peddlers</span>
					<Logo />
				</h1>
				<div class="text-lg italic text-center border-t font-display py-sm mt-sm border-stone-400">Games, LARPs, and other mirthful shenanigans!</div>
			</div>
			<div>
				Lorem ipsum dolor sit amet consectetur adipisicing elit. Optio temporibus ad, ullam minus nostrum nulla in quaerat magnam numquam commodi similique aperiam, dolorum
				sit distinctio voluptate hic nemo! Repellat, modi.
			</div>
		</header>
		<main class="py-lg">
			<section class="py-lg">
				<h2 class="text-3xl font-bold font-display text-body px-lg">Itch.io Games</h2>
				<div class="max-w-full overflow-x-auto p-lg">
					<ul class="flex gap-md w-fit">
						{
							itchGames.map((game) => (
								<li class="w-60">
									<ItchCard game={game} />
								</li>
							))
						}
					</ul>
				</div>
			</section>

			<section data-test="articles-section" class="px-lg">
				<h2 class="text-3xl font-bold font-display mb-base text-body">Blog</h2>
				<div class="grid grid-cols-1 gap-md md:grid-cols-2 lg:grid-cols-3">
					{
						sortedPosts.map((p) => (
							<div class="col-span-1">
								<Card post={p} />
							</div>
						))
					}
				</div>
			</section>
		</main>

		<section class="flex justify-center pt-8 space-x-8 text-xl font-bold">
			<a href="/posts" class="mr-8" data-test="see-all-link">
				See All<span class="squiggle">&rarr;</span>
			</a>
		</section>

		<Footer />
	</body>
</html>
